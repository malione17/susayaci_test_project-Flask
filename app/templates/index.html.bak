<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GerÃ§ek ZamanlÄ± WebSocket Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>GerÃ§ek ZamanlÄ± MQTT Verisi Test (WebSocket)</h1>
            <button class="toggle-btn" onclick="toggleDarkMode()">ğŸŒ™ Tema DeÄŸiÅŸtir</button>
        </header>

        <div class="card">
            <div class="card-header">Veri Tablosu</div>
            <div class="card-content">
                <table class="sensor-table" id="sensorTable">
                    <thead>
                        <tr>
                            <th>ID (Frame Counter)</th>
                            <th>Tarih/Saat</th>
                            <th>Device ID</th>
                            <th>Probe ID</th>
                            <th>manual_value</th>
                            <th>remote_value</th>
                            <th>Image</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body"></tbody>
                </table>
            </div>
        </div>

        <footer>Developed by Controlix - 2025</footer>
    </div>

    <script>
    // WebSocket baÄŸlantÄ±sÄ±nÄ± kuruyoruz. Bu kÄ±sÄ±m aynÄ±.
    const ws = new WebSocket(`ws://${location.host}/ws`);

    // Sunucudan canlÄ± bir mesaj geldiÄŸinde bu fonksiyon Ã§alÄ±ÅŸÄ±r.
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        const table = document.getElementById("data-table-body");
        const row = document.createElement("tr");
        row.classList.add("fade-in");

        // Tablo satÄ±rÄ±nÄ± gelen veriyle dolduruyoruz.
        // Dikkat: FotoÄŸraf hÃ¼cresindeki deÄŸiÅŸiklik en Ã¶nemlisi.
        row.innerHTML = `
            <td>${data.fcnt || 'N/A'}</td>
            <td>${data.timestamp}</td>
            <td>${data.device_id}</td>
            <td>${data.probe_id || ''}</td>
            <td>${data.manual_value || ''}</td>
            <td>${data.remote_value || ''}</td>
            <td>
                ${data.image_path ? // EÄŸer 'image_path' verisi varsa...
                    // FotoÄŸrafÄ± yeni sekmede aÃ§an bir link (<a>) oluÅŸtur.
                    // Bu linkin iÃ§inde kÃ¼Ã§Ã¼k bir Ã¶nizleme resmi (<img>) gÃ¶ster.
                    `<a href="${data.image_path}" target="_blank">
                        <img src="${data.image_path}" alt="Cihaz GÃ¶rÃ¼ntÃ¼sÃ¼" width="100">
                     </a>`
                    : // EÄŸer 'image_path' verisi yoksa...
                    'FotoÄŸraf Yok' // "FotoÄŸraf Yok" metnini gÃ¶ster.
                }
            </td>
        `;
        table.prepend(row); // Yeni satÄ±rÄ± tablonun en Ã¼stÃ¼ne ekle.
    };

    // Sayfa ilk yÃ¼klendiÄŸinde eski verileri Ã§eken kÄ±sÄ±m.
    fetch('/last_data')
        .then(response => response.json())
        .then(data => {
            const table = document.getElementById("data-table-body");
            const items = Array.isArray(data) ? data : data.data || [];

            items.forEach(item => {
                const row = document.createElement("tr");
                row.classList.add("fade-in");
                // AynÄ± mantÄ±ÄŸÄ± buraya da uyguluyoruz.
                row.innerHTML = `
                    <td>${item.fcnt || 'N/A'}</td>
                    <td>${item.timestamp}</td>
                    <td>${item.device_id}</td>
                    <td>${item.probe_id || ''}</td>
                    <td>${item.manual_value || ''}</td>
                    <td>${item.remote_value || ''}</td>
                    <td>
                        ${item.image_path ?
                            `<a href="${item.image_path}" target="_blank">
                                <img src="${item.image_path}" alt="Cihaz GÃ¶rÃ¼ntÃ¼sÃ¼" width="100">
                             </a>`
                            :
                            'FotoÄŸraf Yok'
                        }
                    </td>
                `;
                table.appendChild(row); // Eski verileri tablonun sonuna ekle.
            });
        });

    // Tema deÄŸiÅŸtirme fonksiyonu aynÄ± kalabilir.
    function toggleDarkMode() {
        document.body.classList.toggle("dark");
        // ... (bu fonksiyonun iÃ§eriÄŸi deÄŸiÅŸmedi)
    }
</script>
</body>
</html>